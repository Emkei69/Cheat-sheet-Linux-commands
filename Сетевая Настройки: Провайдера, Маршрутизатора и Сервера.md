Предисловие  

(В данном руководстве подробно описан правильный и последовательный порядок настройки комплексной сетевой схемы. Здесь представлены конфигурации для различных компонентов сети — от провайдера и основных маршрутизаторов до серверов и клиентов. Особое внимание уделено настройкам интерфейсов, NAT, маршрутизации, туннелям GRE и протоколу OSPF, а также службам DNS и DHCP. Это руководство поможет системным администраторам и инженерам настроить и обеспечить стабильную и безопасную работу корпоративной сети)

==========NetProvider==========

-------имя хоста---------
(Установка имени хоста системы)
```hostnamectl hostname NetProvider```
```exec bash```

-------настройка ВНУТРЕННИХ интерфейсов---------
(Создание каталогов и файлов конфигурации для внутренних сетевых интерфейсов, задание типа интерфейса и IP-адресов)
```mkdir -p /etc/net/ifaces/ens19```
```mkdir -p /etc/net/ifaces/ens20```

```echo 'TYPE=eth' > /etc/net/ifaces/ens19/options```
```echo 'TYPE=eth' > /etc/net/ifaces/ens20/options```

```echo '172.16.4.1/28' > /etc/net/ifaces/ens19/ipv4address```
```echo '172.16.5.1/28' > /etc/net/ifaces/ens20/ipv4address```

-------настройка NAT---------
(Установка и конфигурация nftables для NAT (маскарадинг) на внешнем интерфейсе)
```apt-get update && apt-get install nftables -y```
```vim /etc/nftables/nftables.nft```

```
#!/usr/sbin/nft -f

flush ruleset

table ip nat {

chain postrouting {

type nat hook postrouting priority srcnat;

oifname "ens18" masquerade

}

}
```

```systemctl enable --now nftables```

-------включение маршрутизации---------
(Включение IP-маршрутизации в ядре Linux и перезапуск сетевого сервиса)
```echo net.ipv4.ip_forward=1 >> /etc/net/sysctl.conf```
```systemctl restart network```
```sysctl -p```
```sysctl net.ipv4.ip_forward```

==========MainRouter==========

-------имя хоста---------
(Переход в режим конфигурации и установка имени хоста и доменного имени маршрутизатора)
```ecorouter>en```
```ecorouter#configure terminal```
```ecorouter(config)#hostname MainRouter.au-team.irpo```
```MainRouter.au-team.irpo(config)#ip domain-name au-team.irpo```

-------настройка NTP/DNS---------
(Настройка DNS-сервера и часового пояса NTP)
```(config)#ip name-server 192.168.1.10```
```(config)#ntp timezone utc+3```

-------настройка УЗ net_admin---------
(Создание учетных записей пользователей)
(Создание пользователя net_admin с ролью администратора)
```(config)#username net_admin```
```(config-user)#password P@$word```
```(config-user)#role admin```
```(config-user)#exit```

-------пул DHCP---------
(Создание пула IP-адресов для DHCP с указанием диапазона)
```(config)#ip pool dhcp 1```
```(config-ip-pool)# range 192.168.2.2-192.168.2.9```
```(config-ip-pool)#exit```

-------настройка параметров DHCP сервера---------
(Настройка DHCP-сервера)
(Конфигурация параметров DHCP: маска, шлюз, DNS, доменное имя и статический IP для клиента)
```(config)#dhcp-server 1```
```(config-dhcp-server)#pool dhcp 64```
```(config-dhcp-server-pool)#mask 255.255.255.240```
```(config-dhcp-server-pool)#gateway 192.168.2.1```
```(config-dhcp-server-pool)#dns 192.168.1.10```
```(config-dhcp-server-pool)#domain-name au-team.irpo```
```(config-dhcp-server-pool)#static ip 192.168.2.10```
```(config-dhcp-server-static)#client-id mac 1111.1111.1111```
```(config-dhcp-server-static)#exit```
```(config-dhcp-server)#exit```

-------настройка внешнего интерфейса-------
(Экземпляр службы)
(Конфигурация порта и создание service-instance с untagged инкапсуляцией)
```(config)#port te0```
```(config-port)#service-instance te0/netprovider-hq```
```(config-service-instance)#encapsulation untagged```
```(config-service-instance)#exit```
```(config-port)#exit```

-------настройка Service Instance---------
(Создание нескольких service-instance с разными VLAN тегами и настройка переписывания тегов)
```(config)#port te1```
```(config-port)#service-instance te1/srv-net```
```(config-service-instance)#encapsulation dot1q 100```
```(config-service-instance)#rewrite pop 1```
```(config-service-instance)#service-instance te1/cli-net```
```(config-service-instance)#encapsulation dot1q 200```
```(config-service-instance)#rewrite pop 1```
```(config-service-instance)#service-instance te1/management```
```(config-service-instance)#encapsulation dot1q 999```
```(config-service-instance)#rewrite pop 1```
```(config-service-instance)#exit```
```(config-port)#exit```

-------настройка адресации интерфейсов-------------
(Назначение IP-адресов интерфейсам, настройка NAT inside/outside и привязка к service-instance)
```(config)#interface netprovider-hq```
```(config-if)#ip nat outside```
```(config-if)#ip address 172.16.4.4/28```
```(config-if)#connect port te0 service-instance te0/netprovider-hq```
```(config-if)#exit```

```(config)#interface srv-net```
```(config-if)#ip nat inside```
```(config-if)#ip address 192.168.1.1/26```
```(config-if)#connect port te1 service-instance te1/srv-net```
```(config-if)#exit```

```(config)#interface cli-net```
```(config-if)#ip nat inside```
```(config-if)#ip address 192.168.2.1/28```
```(config-if)#connect port te1/service-instance te1/cli-net```
```(config-if)#exit```

```(config)#interface management```
```(config-if)#ip address 192.168.99.1/29```
```(config-if)#connect port te1/service-instance te1/management```
```(config-if)#exit```

-------настройка NAT---------
(Создание NAT пула и настройка динамического NAT с перегрузкой через внешний интерфейс)
```(config)#ip nat pool nat 192.168.1.1-192.168.2.254,192.168.99.1-192.168.99.254```
```(config)#ip nat source dynamic inside-to-outside pool nat overload interface netprovider-hq```

-------настройка маршрута по умолчанию---------
(Добавление маршрута по умолчанию через шлюз провайдера)
```(config)#ip route 0.0.0.0/0 172.16.4.1 description default```

-------настройка туннеля GRE---------
(Создание GRE туннеля с IP-адресацией и настройкой аутентификации OSPF на туннеле)
```(config)#interface tunnel.1```
```(config-if-tunnel)#ip add 192.168.5.1/30```
```(config-if-tunnel)#ip tunnel 172.16.4.4 172.16.5.5 mode gre```
```(config-if-tunnel)#ip ospf authentication```
```(config-if-tunnel)#ip ospf authentication-key P@$word```
```(config-if-tunnel)#exit```

-------настройка OSPF---------
(Конфигурация протокола OSPF с указанием сетей, пассивных интерфейсов и активацией туннеля)
```(config)#router ospf 1```
```(config-router)#network 192.168.5.0/30 area 0```
```(config-router)#network 192.168.1.0/26 area 0```
```(config-router)#network 192.168.2.0/28 area 0```
```(config-router)#network 192.168.99.0/29 area 0```
```(config-router)#passive-interface default```
```(config-router)#no passive-interface tunnel.1```
```(config-router)#exit```
```(config)#exit```

-------запись конфигурации---------
(Сохранение конфигурации маршрутизатора)
```MainRouter.au-team.irpo#write```

-------команды проверки---------
(Просмотр краткой информации об интерфейсах, портах, маршрутах и текущей конфигурации)
```MainRouter.au-team.irpo#show ip interface brief```
```MainRouter.au-team.irpo#show port brief```
```MainRouter.au-team.irpo#sh ip route```
```MainRouter.au-team.irpo#sh running-config```

==========BranchRouter==========

-------имя хоста---------
(Установка имени хоста и доменного имени маршрутизатора филиала)
```ecorouter>en```
```ecorouter#configure terminal```
```ecorouter(config)#hostname BranchRouter.au-team.irpo```
```BranchRouter.au-team.irpo(config)#ip domain-name au-team.irpo```

-------настройка NTP/DNS---------
(Настройка DNS-сервера и часового пояса NTP)
```(config)#ip name-server 192.168.1.10```
```(config)#ntp timezone utc+3```

-------настройка УЗ net_admin---------
(Создание учетных записей пользователей)
(Создание пользователя net_admin с ролью администратора)
```(config)#username net_admin```
```(config-user)#password P@$word```
```(config-user)#role admin```
```(config-user)#exit```

-------настройка Service Instance-------4.9 Service Instance
(Создание service-instance для портов с untagged инкапсуляцией)
```(config)#port te0```
```(config-port)#service-instance te0/netprovider-br```
```(config-service-instance)#encapsulation untagged```
```(config-service-instance)#exit```
```(config-port)#exit```

```(config)#port te1```
```(config-port)#service-instance te1/branchrouter-net```
```(config-service-instance)#encapsulation untagged```
```(config-service-instance)#exit```
```(config-port)#exit```

-------настройка адресации интерфейсов-------------
(Настройка IP-адресов интерфейсов, NAT inside/outside и привязка к service-instance)
```(config)#interface netprovider-br```
```(config-if)#ip nat outside```
```(config-if)#ip address 172.16.5.5/28```
```(config-if)#connect port te0 service-instance te0/netprovider-br```
```(config-if)#exit```

```(config)#interface branchrouter-net```
```(config-if)# ip nat inside```
```(config-if)#ip address 192.168.3.1/27```
```(config-if)# connect port te1 service-instance te1/branchrouter-net```

-------настройка NAT---------28 Встроенный NAT
(Создание NAT пула и настройка динамического NAT с перегрузкой через внешний интерфейс)
```(config)#ip nat pool nat 192.168.3.1-192.168.3.254```
```(config)#ip nat source dynamic inside-to-outside pool nat overload interface netprovider-br```

-------настройка маршрута по умолчанию---------13.4 Маршрут по умолчанию
(Добавление маршрута по умолчанию через шлюз провайдера филиала)
```(config)#ip route 0.0.0.0/0 172.16.5.1 description default```

-------настройка туннеля GRE---------15.1 GRE
(Создание GRE туннеля с IP-адресацией и настройкой аутентификации OSPF на туннеле)
```(config)#interface tunnel.1```
```(config-if-tunnel)#ip add 192.168.5.2/30```
```(config-if-tunnel)#ip tunnel 172.16.5.5 172.16.4.4 mode gre```
```(config-if-tunnel)#ip ospf authentication```
```(config-if-tunnel)#ip ospf authentication-key P@$word```
```(config-if-tunnel)#exit```

-------настройка OSPF---------13.4 Настройка OSPF
(Конфигурация протокола OSPF с указанием сетей, пассивных интерфейсов и активацией туннеля)
```(config)#router ospf 1```
```(config-router)#network 192.168.5.0/30 area 0```
```(config-router)#network 192.168.3.0/27 area 0```
```(config-router)#passive-interface default```
```(config-router)#no passive-interface tunnel.1```
```(config-router)#exit```
```(config)#exit```

-------команды проверки---------
(Сохранение конфигурации и просмотр состояния интерфейсов, портов, маршрутов и текущей конфигурации)
```MainRouter.au-team.irpo#write```
```MainRouter.au-team.irpo#show ip interface brief```
```MainRouter.au-team.irpo#show port brief```
```MainRouter.au-team.irpo#sh ip route```
```MainRouter.au-team.irpo#sh running-config```

==========MainServer==========

-------имя хоста/NTP---------
(Установка имени хоста и часового пояса сервера)
```hostnamectl hostname MainServer.au-team.irpo```
```exec bash```
```timedatectl set-timezone Europe/Moscow```

-------настройка интерфейсов-------------
(Конфигурация сетевого интерфейса с IP-адресом, маршрутом по умолчанию и DNS)
```echo 'TYPE=eth' > /etc/net/ifaces/ens19/options```
```echo '192.168.1.10/26' > /etc/net/ifaces/ens19/ipv4address```
```echo 'default via 192.168.1.1' > /etc/net/ifaces/ens19/ipv4route```
```echo 'nameserver 1.1.1.1' > /etc/net/ifaces/ens19/resolv.conf```
```systemctl restart network```

-------DnsMasq-------------
(Установка и настройка dnsmasq для локального DNS и DHCP кеширования с указанием записей и алиасов)
```apt-get update && apt-get install dnsmasq -y```
```echo 'OPTIONS=""' > /etc/sysconfig/dnsmasq```

```vim /etc/dnsmasq.conf```

```
no-resolv
no-poll
no-hosts

server=8.8.8.8
cache-size=1000
all-servers
no-negcache

address=/mainrouter.au-team.irpo/192.168.1.1
address=/branchrouter.au-team.irpo/192.168.3.1
address=/mainserver.au-team.irpo/192.168.1.10
address=/mainclient.au-team.irpo/192.168.2.10
address=/branchserver.au-team.irpo/192.168.3.10

host-record=mainrouter.au-team.irpo,192.168.1.1
host-record=mainserver.au-team.irpo,192.168.1.10
host-record=mainclient.au-team.irpo,192.168.2.10

cname=moodle.au-team.irpo,mainrouter.au-team.irpo
cname=wiki.au-team.irpo,mainrouter.au-team.irpo
```

```systemctl enable --now dnsmasq```
```echo 'nameserver 127.0.0.1' > /etc/net/ifaces/ens19/resolv.conf```
```service network restart```

-------настройка sshuser-------------
(Создание пользователя sshuser с uid 1010 и добавление в группу wheel для sudo прав)
```useradd -u 1010 sshuser```
```passwd sshuser```
```usermod -aG wheel sshuser```

==========BranchServer==========

-------имя хоста/NTP---------
(Установка имени хоста и часового пояса сервера филиала)
```hostnamectl hostname BranchServer.au-team.irpo```
```exec bash```
```timedatectl set-timezone Europe/Moscow```

-------настройка интерфейсов-------------
(Конфигурация сетевого интерфейса с IP-адресом, маршрутом по умолчанию и DNS)
```echo 'TYPE=eth' > /etc/net/ifaces/ens18/options```
```echo '192.168.3.10/27' > /etc/net/ifaces/ens18/ipv4address```
```echo 'default via 192.168.3.1' > /etc/net/ifaces/ens18/ipv4route```
```echo 'nameserver 192.168.1.10' > /etc/net/ifaces/ens18/resolv.conf```
```service network restart```

-------настройка sshuser-------------
(Создание пользователя sshuser, установка пароля, добавление в wheel и настройка sudo без пароля)
```useradd -u 1010 sshuser```
```passwd sshuser```
```usermod -aG wheel sshuser```
```vim /etc/sudoers```
(Добавить строку: WHEEL_USERS ALL=(ALL:ALL) NOPASSWD: ALL)

--------настройка SSH----------------
(Настройка SSH сервера: нестандартный порт, разрешение доступа только sshuser, ограничение попыток аутентификации и баннер)
```echo "Authorized access only" > /etc/openssh/banner```
(В файле /etc/openssh/sshd_config)

```
Port 2224
AllowUsers sshuser
MaxAuthTries 2
Banner /etc/openssh/banner
```

```systemctl restart sshd```

==========MainClient==========

-------имя хоста/NTP---------
(Установка имени хоста и часового пояса клиента, настройка DHCP client-id через nmcli)
```hostnamectl hostname MainClient.au-team.irpo```
```exec bash```
```timedatectl set-timezone Europe/Moscow```

```nmcli connection modify 'Wired connection 1' ipv4.dhcp-client-id 01:11:11:11:11:11:11```
```nmcli connection show```

-------настройка ВНЕШНЕГО интерфейса---------
(Переименование каталога конфигурации внешнего интерфейса)
```mv /etc/net/ifaces/ens18/ /etc/net/ifaces/ens19/```

-------настройка ВНУТРЕННИХ интерфейсов---------
(Создание каталогов и файлов конфигурации для внутренних интерфейсов с назначением IP-адресов)
```mkdir -p /etc/net/ifaces/ens2{0,1}```
```echo 'TYPE=eth' | tee /etc/net/ifaces/ens2{0,1}/options```
```echo '172.16.4.1/28' > /etc/net/ifaces/ens20/ipv4address```
```echo '172.16.5.1/28' > /etc/net/ifaces/ens21/ipv4address```
```systemctl restart network```

-------настройка NAT---------
(Установка и настройка nftables для NAT (маскарадинг) на внешнем интерфейсе)
```apt-get update && apt-get install nftables -y```
```vim /etc/nftables/nftables.nft```

```
#!/usr/sbin/nft -f
flush ruleset

table ip nat {
chain postrouting {
type nat hook postrouting priority srcnat;
oifname "ens19" masquerade
}
}
```

```systemctl enable --now nftables```

-------включение маршрутизации---------
(Включение IP-маршрутизации в ядре и применение настроек)
```echo net.ipv4.ip_forward=1 >> /etc/sysctl.conf```
```sysctl -p```
